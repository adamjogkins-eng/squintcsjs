<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PRISM V3 + SQUINT</title>
    
    <!-- WEB APP / ADD TO HOME SCREEN CONFIG -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SquintEngine">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- ICON LINKING -->
    <link rel="icon" type="image/jpeg" href="IMG_8839.jpeg">
    <link rel="apple-touch-icon" href="IMG_8839.jpeg">

    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #00f2ff;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --bg: #050508;
        }
        
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            box-sizing: border-box;
        }

        body { 
            margin: 0; 
            overflow: hidden; 
            background: var(--bg); 
            font-family: 'Space Grotesk', sans-serif; 
            color: white; 
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0; left: 0;
            overscroll-behavior: none;
        }
        
        canvas { 
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%; 
            display: block; 
            z-index: 1;
            touch-action: none;
        }
        
        #ui {
            position: absolute;
            top: calc(env(safe-area-inset-top, 20px) + 10px); 
            left: 20px;
            background: var(--glass);
            padding: 10px 15px;
            border-radius: 12px;
            pointer-events: none;
            border: 1px solid var(--border);
            backdrop-filter: blur(20px);
            z-index: 100;
        }

        #top-actions {
            position: absolute;
            top: calc(env(safe-area-inset-top, 20px) + 10px); 
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 200;
        }

        .action-btn {
            width: 44px; height: 44px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 50%;
            color: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: 500; cursor: pointer;
            backdrop-filter: blur(10px);
            pointer-events: auto;
        }

        #tutorial-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 8, 0.98);
            z-index: 1000;
            display: none;
            overflow-y: scroll; /* Force scrolling */
            -webkit-overflow-scrolling: touch;
            padding: calc(env(safe-area-inset-top) + 20px) 20px 120px 20px;
            backdrop-filter: blur(20px);
            touch-action: pan-y !important; /* Allow vertical touch scrolling */
            user-select: text;
        }

        .tutorial-card {
            background: var(--glass);
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            pointer-events: auto;
        }

        .code-container {
            position: relative;
            margin: 15px 0;
        }

        .copy-btn {
            position: absolute;
            top: 10px; right: 10px;
            background: var(--accent);
            color: black;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            cursor: pointer;
            z-index: 10;
        }

        pre { 
            background: #000; padding: 15px; border-radius: 10px; border: 1px solid var(--border); 
            overflow-x: auto; color: #ddd; user-select: all; 
            font-size: 0.8rem; white-space: pre-wrap; word-break: break-all;
            margin: 0;
            font-family: monospace;
        }

        #controls {
            position: absolute;
            bottom: calc(env(safe-area-inset-bottom, 20px) + 60px); 
            left: 0; width: 100%;
            display: flex; 
            justify-content: space-between;
            padding: 0 40px; 
            box-sizing: border-box;
            pointer-events: none; 
            z-index: 800;
        }

        .ctrl-btn {
            width: 80px; height: 80px;
            background: rgba(255, 255, 255, 0.12);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            pointer-events: auto; 
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 35px;
            backdrop-filter: blur(15px);
            touch-action: none;
        }

        .ctrl-btn.active { 
            background: var(--accent); 
            color: #000; 
            border-color: var(--accent);
            transform: scale(0.9);
            box-shadow: 0 0 25px var(--accent);
        }

        .brand { font-weight: 700; font-size: 0.6rem; color: var(--accent); text-transform: uppercase; letter-spacing: 2px; }
        .score-val { font-size: 1.8rem; font-weight: 700; display: block; }
        
        #gameover {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(10, 5, 5, 0.98);
            padding: 30px;
            width: 80%;
            border-radius: 25px;
            text-align: center;
            display: none;
            border: 1px solid #ff4444;
            z-index: 500;
        }

        .primary-btn {
            background: var(--accent); color: #000;
            border: none; padding: 16px;
            border-radius: 50px; font-weight: 700; cursor: pointer;
            width: 100%; margin-top: 15px;
            display: block;
            text-align: center;
            text-decoration: none;
            pointer-events: auto;
        }

        h2 { color: var(--accent); margin-top: 0; }
        a { color: var(--accent); text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>
    <div id="ui">
        <span class="brand">SQUINT ENGINE</span><br>
        <span id="score" class="score-val">0</span>
    </div>

    <div id="top-actions">
        <div class="action-btn" id="btnReset">R</div>
        <div class="action-btn" id="btnTutorial">?</div>
    </div>

    <div id="controls">
        <div class="ctrl-btn" id="leftBtn">‚Üê</div>
        <div class="ctrl-btn" id="rightBtn">‚Üí</div>
    </div>

    <div id="tutorial-overlay">
        <div style="max-width: 600px; margin: 0 auto;">
            <button class="primary-btn" onclick="toggleTutorial()">BACK TO GAME</button>
            
            <h1 style="color:var(--accent); margin-top:30px;">PRISM V3 + SQUINT GUIDE</h1>

            <div class="tutorial-card">
                <h2>üì± App Setup (Remove Bars)</h2>
                <p>1. Open in <strong>Safari</strong>.<br>
                2. Tap the <strong>Share</strong> icon.<br>
                3. Select <strong>"Add to Home Screen"</strong>.</p>
                <p style="font-size: 0.8rem; opacity: 0.7;">Using icon: <code>IMG_8839.jpeg</code></p>
            </div>

            <div class="tutorial-card">
                <h2>üöÄ Squint Implementation</h2>
                <p>Compile ClojureScript directly in the browser:</p>
                <div class="code-container">
                    <button class="copy-btn" onclick="copyCode(this)">COPY</button>
                    <pre>import { compileString } from 'https://unpkg.com/squint-cljs/index.js';

const cljsCode = '(defn greet [n] (str "Hello " n))';
const jsCode = compileString(cljsCode);
console.log(jsCode);</pre>
                </div>
            </div>

            <div class="tutorial-card">
                <h2>ü§ù Community & Support</h2>
                <p>Need help or want to contribute to the Squint ecosystem?</p>
                <ul style="list-style: none; padding: 0;">
                    <li style="margin-bottom: 10px;">üåê <a href="https://github.com/squint-cljs/squint" target="_blank">Squint GitHub Repo</a></li>
                    <li style="margin-bottom: 10px;">üí¨ <a href="https://clojurians.slack.com/archives/C04DX8M3A6U" target="_blank">Clojurians Slack #squint</a></li>
                    <li style="margin-bottom: 10px;">üìñ <a href="https://github.com/squint-cljs/squint#usage" target="_blank">Full Documentation</a></li>
                    <li style="margin-bottom: 10px;">üì∫ <a href="https://youtube.com/@squintcsjs" target="_blank">YouTube: @squintcsjs</a></li>
                    <li style="margin-bottom: 10px;">üìß <a href="mailto:squintjs@gmail.com">Email: squintjs@gmail.com</a></li>
                </ul>
            </div>

            <div class="tutorial-card">
                <h2>üïπÔ∏è Controls</h2>
                <p><strong>Mobile:</strong> Use the large buttons at the bottom.</p>
                <p><strong>Desktop:</strong> Arrow keys or A/D.</p>
            </div>

            <button class="primary-btn" style="background: transparent; border: 1px solid var(--accent); color: var(--accent);" onclick="toggleTutorial()">CLOSE GUIDE</button>
        </div>
    </div>

    <div id="gameover">
        <h1 style="margin:0; color:#ff4444;">CRASHED</h1>
        <p>Altitude: <span id="finalScore">0</span>m</p>
        <button class="primary-btn" onclick="initGame()">REBOOT</button>
    </div>

    <canvas id="gl"></canvas>

    <script>
        const canvas = document.getElementById('gl');
        const gl = canvas.getContext('webgl2');

        const keys = { left: false, right: false };
        let state = {
            score: 0, camY: 0, posX: 0, posY: 5, velY: 0,
            lastY: 0, playing: true,
            platforms: [], stars: []
        };

        const updateUI = () => {
            document.getElementById('leftBtn').classList.toggle('active', keys.left);
            document.getElementById('rightBtn').classList.toggle('active', keys.right);
        };

        const bindButton = (id, key) => {
            const el = document.getElementById(id);
            const start = (e) => { e.preventDefault(); keys[key] = true; updateUI(); };
            const stop = (e) => { e.preventDefault(); keys[key] = false; updateUI(); };
            el.addEventListener('pointerdown', start);
            el.addEventListener('pointerup', stop);
            el.addEventListener('pointerleave', stop);
            el.addEventListener('pointercancel', stop);
        };

        bindButton('leftBtn', 'left');
        bindButton('rightBtn', 'right');

        function copyCode(btn) {
            const pre = btn.nextElementSibling;
            const text = pre.innerText;
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                btn.innerText = "COPIED!";
                setTimeout(() => { btn.innerText = "COPY"; }, 2000);
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
            document.body.removeChild(textArea);
        }

        const SHADERS = {
            vs: `#version 300 es
                in vec4 a_pos; in vec4 a_col;
                uniform mat4 u_mat;
                out vec4 v_col;
                void main() { gl_Position = u_mat * a_pos; v_col = a_col; }`,
            fs: `#version 300 es
                precision highp float;
                in vec4 v_col; out vec4 color;
                void main() { color = v_col; }`
        };

        function createProgram(gl, vs, fs) {
            const p = gl.createProgram();
            [vs, fs].forEach((src, i) => {
                const s = gl.createShader(i ? gl.FRAGMENT_SHADER : gl.VERTEX_SHADER);
                gl.shaderSource(s, src); gl.compileShader(s); gl.attachShader(p, s);
            });
            gl.linkProgram(p); return p;
        }

        const prog = createProgram(gl, SHADERS.vs, SHADERS.fs);
        const locs = { pos: gl.getAttribLocation(prog, "a_pos"), col: gl.getAttribLocation(prog, "a_col"), mat: gl.getUniformLocation(prog, "u_mat") };
        
        const cubePos = new Float32Array([-1,-1,1, 1,-1,1, 1,1,1, -1,1,1, -1,-1,-1, -1,1,-1, 1,1,-1, 1,-1,-1, -1,1,-1, -1,1,1, 1,1,1, 1,1,-1, -1,-1,-1, 1,-1,-1, 1,-1,1, -1,-1,1, 1,-1,-1, 1,1,-1, 1,1,1, 1,-1,1, -1,-1,-1, -1,-1,1, -1,1,1, -1,1,-1]);
        const cubeIdx = new Uint16Array([0,1,2,0,2,3, 4,5,6,4,6,7, 8,9,10,8,10,11, 12,13,14,12,14,15, 16,17,18,16,18,19, 20,21,22,20,22,23]);
        const posBuf = gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER, posBuf); gl.bufferData(gl.ARRAY_BUFFER, cubePos, gl.STATIC_DRAW);
        const idxBuf = gl.createBuffer(); gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, idxBuf); gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, cubeIdx, gl.STATIC_DRAW);

        function createColorBuffer(rgba) {
            const buf = gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER, buf);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(Array(24).fill(rgba).flat()), gl.STATIC_DRAW);
            return buf;
        }

        const colors = {
            player: createColorBuffer([1, 1, 1, 1]),
            normal: createColorBuffer([0.2, 0.4, 1.0, 1]),
            boost: createColorBuffer([0, 0.95, 1.0, 1]),
            shatter: createColorBuffer([1, 0.2, 0.2, 1]),
            star: createColorBuffer([0.2, 0.2, 0.3, 1])
        };

        function spawnPlatform(y, isStart = false) {
            const typeRoll = Math.random();
            const type = isStart ? 'normal' : (typeRoll > 0.9 ? 'boost' : (typeRoll > 0.75 ? 'shatter' : 'normal'));
            state.platforms.push({ x: isStart ? 0 : (Math.random() - 0.5) * 18, y: y, w: isStart ? 10 : 2 + Math.random() * 2, type: type, buf: colors[type] });
        }

        function initGame() {
            state.score = 0; state.camY = 0; state.posX = 0; state.posY = 5; state.velY = 0;
            state.lastY = 0; state.playing = true; state.platforms = []; state.stars = [];
            for(let i=0; i<60; i++) state.stars.push({x: (Math.random()-0.5)*100, y: Math.random()*200, z: -30});
            for(let i=0; i<15; i++) { state.lastY = i * 6; spawnPlatform(state.lastY, i===0); }
            document.getElementById('gameover').style.display = 'none';
            document.getElementById('score').innerText = "0";
            updateUI();
        }

        const m4 = {
            identity: () => new Float32Array([1,0,0,0, 0,1,0,0, 0,0,1,0, 0,0,0,1]),
            mul: (a, b) => {
                const out = new Float32Array(16);
                for(let i=0; i<4; i++) for(let j=0; j<4; j++) out[j*4+i] = a[i]*b[j*4] + a[i+4]*b[j*4+1] + a[i+8]*b[j*4+2] + a[i+12]*b[j*4+3];
                return out;
            },
            perspective: (fov, aspect, near, far) => {
                const f = 1.0 / Math.tan(fov / 2), nf = 1 / (near - far), out = m4.identity();
                out[0] = f / aspect; out[5] = f; out[10] = (far + near) * nf; out[11] = -1; out[14] = (2 * far * near) * nf; out[15] = 0;
                return out;
            },
            translate: (x, y, z) => { const out = m4.identity(); out[12]=x; out[13]=y; out[14]=z; return out; },
            scale: (x, y, z) => { const out = m4.identity(); out[0]=x; out[5]=y; out[10]=z; return out; }
        };

        function draw(mat, buf, pos, size) {
            gl.bindBuffer(gl.ARRAY_BUFFER, posBuf);
            gl.vertexAttribPointer(locs.pos, 3, gl.FLOAT, false, 0, 0);
            gl.enableVertexAttribArray(locs.pos);
            gl.bindBuffer(gl.ARRAY_BUFFER, buf);
            gl.vertexAttribPointer(locs.col, 4, gl.FLOAT, false, 0, 0);
            gl.enableVertexAttribArray(locs.col);
            const model = m4.mul(m4.translate(pos[0], pos[1], pos[2]), m4.scale(size[0], size[1], size[2]));
            gl.uniformMatrix4fv(locs.mat, false, m4.mul(mat, model));
            gl.drawElements(gl.TRIANGLES, 36, gl.UNSIGNED_SHORT, 0);
        }

        function loop() {
            if (state.playing) {
                state.velY -= 0.015;
                state.posY += state.velY;
                let moveDir = (keys.left ? -1 : 0) + (keys.right ? 1 : 0);
                state.posX += moveDir * 0.3;
                if(Math.abs(state.posX) > 20) state.posX *= -0.9;

                if(state.velY < 0) {
                    state.platforms.forEach((p, i) => {
                        if(state.posY > p.y && state.posY < p.y + 1.2 && Math.abs(state.posX - p.x) < p.w + 0.5) {
                            state.velY = p.type === 'boost' ? 0.75 : 0.45;
                            state.posY = p.y + 0.5;
                            if(p.y > state.score) { state.score = Math.floor(p.y); document.getElementById('score').innerText = state.score; }
                            if(p.type === 'shatter') state.platforms.splice(i, 1);
                        }
                    });
                }
                if(state.posY > state.lastY - 50) { state.lastY += 6; spawnPlatform(state.lastY); }
                state.camY += (state.posY - state.camY) * 0.1;
                if(state.posY < state.camY - 25) { 
                    state.playing = false; 
                    document.getElementById('gameover').style.display = 'block';
                    document.getElementById('finalScore').innerText = state.score;
                }
                canvas.width = window.innerWidth; canvas.height = window.innerHeight;
                gl.viewport(0, 0, canvas.width, canvas.height);
                gl.clearColor(0.02, 0.02, 0.04, 1);
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                gl.enable(gl.DEPTH_TEST);
                const view = m4.mul(m4.perspective(Math.PI/4, canvas.width/canvas.height, 0.1, 1000), m4.translate(0, -state.camY, -40));
                gl.useProgram(prog);
                state.stars.forEach(s => draw(view, colors.star, [s.x, s.y + (state.camY*0.5), s.z], [0.1, 0.1, 0.1]));
                state.platforms.forEach(p => draw(view, p.buf, [p.x, p.y, 0], [p.w, 0.2, 2]));
                draw(view, colors.player, [state.posX, state.posY, 0], [0.6, 0.6, 0.6]);
            }
            requestAnimationFrame(loop);
        }

        function toggleTutorial() {
            const over = document.getElementById('tutorial-overlay');
            over.style.display = over.style.display === 'block' ? 'none' : 'block';
            // Reset scroll to top when opening
            if(over.style.display === 'block') over.scrollTop = 0;
        }

        document.getElementById('btnReset').onclick = () => initGame();
        document.getElementById('btnTutorial').onclick = () => toggleTutorial();

        initGame();
        loop();

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
    </script>
</body>
</html>

